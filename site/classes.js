// ============================================
//   SANCTUM & SHADOW â€” CLASS MECHANICS ENGINE
//   Each class has unique combat resources,
//   passives, and mechanics that fundamentally
//   change how they play in combat
// ============================================

// â”€â”€â”€ CLASS RESOURCE STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Attached to combatState when combat starts
window.classResource = {
  type: null,     // 'rage' | 'holy' | 'charges' | 'surge' | 'combo' | 'focus'
  current: 0,
  max: 0,
  label: '',
  icon: '',
  color: '',
};

// â”€â”€â”€ RESOURCE CONFIG PER CLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CLASS_RESOURCE = {
  warrior: { type:'rage',    max:100, label:'Rage',          icon:'ğŸ”¥', color:'#c0392b',
    desc:'Builds from hits taken and dealt. At 50+ grants bonus damage. At 100: BERSERKER.' },
  paladin: { type:'holy',    max:100, label:'Holy Points',   icon:'âœ',  color:'#f0c060',
    desc:'Generated by smiting and prayer. Spent on divine abilities.' },
  cleric:  { type:'charges', max:3,   label:'Prayer Charges',icon:'ğŸ’«', color:'#6abfff',
    desc:'3 charges per round. Spent to empower heals and channel divinity.' },
  mage:    { type:'surge',   max:5,   label:'Arcane Surge',  icon:'âš—',  color:'#b060ff',
    desc:'Builds per spell cast. At 5: next spell deals double damage then resets.' },
  rogue:   { type:'combo',   max:5,   label:'Combo Points',  icon:'ğŸ—¡',  color:'#4adba2',
    desc:'1 per hit, 2 on crit. Spend 3-5 for devastating finishers.' },
  ranger:  { type:'focus',   max:3,   label:'Focus',         icon:'ğŸ¯', color:'#8bc87a',
    desc:'Builds when you move or hold. Spend for powered shots and abilities.' },
};

// â”€â”€â”€ INIT CLASS RESOURCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initClassResource(char) {
  const cfg = CLASS_RESOURCE[char.class];
  if (!cfg) return;
  window.classResource = {
    type: cfg.type,
    current: cfg.type === 'holy' ? (char.holyPoints || 0) : 0,
    max: cfg.max,
    label: cfg.label,
    icon: cfg.icon,
    color: cfg.color,
    desc: cfg.desc,
  };
  // Warriors start with 0 rage, clerics with full charges
  if (cfg.type === 'charges') window.classResource.current = cfg.max;
}
window.initClassResource = initClassResource;

// â”€â”€â”€ RESOURCE MUTATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function gainResource(amount) {
  const cr = window.classResource;
  if (!cr.type) return;
  const prev = cr.current;
  cr.current = Math.min(cr.max, Math.max(0, cr.current + amount));
  if (cr.current !== prev) updateResourceBar();
}
function spendResource(amount) {
  const cr = window.classResource;
  if (!cr.type) return false;
  if (cr.current < amount) return false;
  cr.current -= amount;
  updateResourceBar();
  return true;
}
window.gainResource = gainResource;
window.spendResource = spendResource;

function updateResourceBar() {
  const bar = document.getElementById('class-resource-bar');
  if (!bar) return;
  const cr = window.classResource;
  const pct = (cr.current / cr.max) * 100;
  const fill = bar.querySelector('.crb-fill');
  const label = bar.querySelector('.crb-label');
  const val = bar.querySelector('.crb-val');
  if (fill) { fill.style.width = pct + '%'; fill.style.background = cr.color; }
  if (label) label.textContent = `${cr.icon} ${cr.label}`;
  if (val) val.textContent = `${cr.current}/${cr.max}`;

  // Visual state changes
  const crb = bar.querySelector('.crb-track');
  if (crb) {
    if (cr.type === 'rage' && cr.current >= 100) {
      crb.style.boxShadow = '0 0 12px rgba(192,57,43,0.8)';
      bar.classList.add('berserker');
    } else if (cr.type === 'surge' && cr.current >= 5) {
      crb.style.boxShadow = '0 0 12px rgba(176,96,255,0.8)';
      bar.classList.add('overloaded');
    } else {
      crb.style.boxShadow = 'none';
      bar.classList.remove('berserker', 'overloaded');
    }
  }
}
window.updateResourceBar = updateResourceBar;

// â”€â”€â”€ PASSIVE: ON PLAYER HIT TAKEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnHitTaken(dmg) {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (cls === 'warrior') {
    const rage = Math.min(20, Math.floor(dmg * 0.6));
    gainResource(rage);
    if (cr.current >= 50 && cr.current - rage < 50) {
      addLog('ğŸ”¥ RAGE THRESHOLD! Your attacks now deal bonus damage!', 'combat');
    }
    if (cr.current >= 100) {
      addLog('ğŸ”¥ğŸ”¥ BERSERKER! You are unstoppable â€” +100% damage until rage fades!', 'hell');
    }
  }
}
window.classOnHitTaken = classOnHitTaken;

// â”€â”€â”€ PASSIVE: ON PLAYER HIT DEALT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnHitDealt(dmg, isCrit) {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (cls === 'warrior') {
    gainResource(10);
  }
  if (cls === 'rogue') {
    const pts = isCrit ? 2 : 1;
    gainResource(pts);
    if (cr.current >= 5) {
      addLog('ğŸ—¡ 5 COMBO POINTS â€” Finisher available! Use Phantom Kill, Garrote, or Sneak Attack at full power.', 'holy');
    }
  }
  if (cls === 'paladin') {
    gainResource(5); // smiting builds holy
    if (gameState.character) gameState.character.holyPoints = Math.min(100, (gameState.character.holyPoints || 0) + 5);
  }
}
window.classOnHitDealt = classOnHitDealt;

// â”€â”€â”€ PASSIVE: ON SPELL CAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnSpellCast(spellId) {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (cls === 'mage') {
    gainResource(1);
    if (cr.current >= 5) {
      addLog('âš— ARCANE SURGE MAXED! Next spell deals DOUBLE DAMAGE â€” then resets!', 'holy');
    }
  }
  if (cls === 'cleric') {
    // Spending a charge for healing spells
    const healSpells = ['cure_wounds','mass_heal','revivify','lay_on_hands'];
    if (healSpells.includes(spellId)) {
      if (cr.current > 0) {
        spendResource(1);
        addLog('ğŸ’« Prayer Charge spent â€” heal empowered!', 'holy');
        return true; // empowered
      }
    }
  }
  return false;
}
window.classOnSpellCast = classOnSpellCast;

// â”€â”€â”€ PASSIVE: START OF PLAYER TURN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnTurnStart() {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (cls === 'cleric') {
    // Refresh charges each round
    if (cr.current < cr.max) {
      cr.current = cr.max;
      updateResourceBar();
      addLog('ğŸ’« Prayer Charges refreshed (3/3)', 'system');
    }
  }
  if (cls === 'ranger') {
    // Focus builds passively
    gainResource(1);
  }
}
window.classOnTurnStart = classOnTurnStart;

// â”€â”€â”€ PASSIVE: ON MOVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnMove() {
  const cls = gameState.character?.class;
  if (cls === 'ranger') {
    gainResource(1);
    addLog('ğŸ¯ Focus gained from repositioning! (' + window.classResource.current + '/' + window.classResource.max + ')', 'system');
  }
}
window.classOnMove = classOnMove;

// â”€â”€â”€ DAMAGE MULTIPLIER FROM CLASS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getClassDmgMult() {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (!cls) return 1;

  if (cls === 'warrior') {
    if (cr.current >= 100) return 2.0;    // Berserker
    if (cr.current >= 50)  return 1.35;   // Rage threshold
    return 1.0;
  }
  if (cls === 'mage' && cr.current >= 5) {
    gainResource(-cr.current); // reset surge
    addLog('âš— Arcane Surge consumed â€” DOUBLE DAMAGE!', 'holy');
    return 2.0;
  }
  if (cls === 'rogue') {
    if (cr.current >= 5) {
      spendResource(5);
      addLog('ğŸ—¡ COMBO FINISHER â€” 5 Combo Points burned for max power!', 'hell');
      return 2.5;
    }
    if (cr.current >= 3) return 1.5;
  }
  if (cls === 'ranger' && cr.current >= 2) {
    spendResource(2);
    addLog('ğŸ¯ Focus spent â€” Powered Shot!', 'holy');
    return 1.6;
  }
  return 1.0;
}
window.getClassDmgMult = getClassDmgMult;

// â”€â”€â”€ CLASS PASSIVE AC BONUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getClassAcBonus() {
  const cls = gameState.character?.class;
  const char = gameState.character;
  if (!cls || !char) return 0;
  const dexMod = Math.floor(((char.stats?.dex || 10) - 10) / 2);
  const wisMod = Math.floor(((char.stats?.wis || 10) - 10) / 2);
  if (cls === 'paladin') return 2;               // Heavy armor passive
  if (cls === 'ranger')  return dexMod;          // Agility
  if (cls === 'rogue')   return Math.floor(dexMod * 1.5); // Evasion
  if (cls === 'cleric')  return wisMod;          // Divine ward
  return 0;
}
window.getClassAcBonus = getClassAcBonus;

// â”€â”€â”€ CLASS PASSIVE INIT HP BONUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getClassHpBonus() {
  // Already baked into startingHP in data.js, but level scaling differs
  const cls = gameState.character?.class;
  const conMod = Math.floor(((gameState.character?.stats?.con || 10) - 10) / 2);
  const hpPerLevel = { warrior:12, paladin:10, cleric:8, mage:6, rogue:8, ranger:9 };
  return (hpPerLevel[cls] || 8) + conMod;
}
window.getClassHpBonus = getClassHpBonus;

// â”€â”€â”€ PALADIN AURA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getPaladinAuraReduction() {
  if (gameState.character?.class !== 'paladin') return 0;
  const wisMod = Math.floor(((gameState.character?.stats?.wis || 10) - 10) / 2);
  return Math.max(0, 2 + wisMod); // 2 + WIS mod flat damage reduction
}
window.getPaladinAuraReduction = getPaladinAuraReduction;

// â”€â”€â”€ ROGUE FIRST STRIKE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window._rogueFirstStrikeDone = false;
function getRogueFirstStrikeBonus() {
  if (gameState.character?.class !== 'rogue') return 0;
  if (window._rogueFirstStrikeDone) return 0;
  window._rogueFirstStrikeDone = true;
  addLog('ğŸŒ‘ SHADOW OPENER â€” First strike deals double damage!', 'hell');
  return 2.0; // multiplier for first attack
}
window.getRogueFirstStrikeBonus = getRogueFirstStrikeBonus;

// â”€â”€â”€ WARRIOR RAGE DECAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function classOnRoundEnd() {
  const cls = gameState.character?.class;
  const cr = window.classResource;
  if (cls === 'warrior' && cr.current > 0) {
    gainResource(-10); // Rage decays 10 per round
    if (cr.current < 50 && cr.current + 10 >= 50) {
      addLog('ğŸ”¥ Rage falling below threshold â€” bonus damage fading.', 'system');
    }
  }
}
window.classOnRoundEnd = classOnRoundEnd;

// â”€â”€â”€ MAGE GLASS CANNON PENALTY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getMageVulnerability(dmgIn) {
  if (gameState.character?.class !== 'mage') return dmgIn;
  const player = combatState.combatants['player'];
  if (!player) return dmgIn;
  // Below 30% HP: mage takes +25% damage (no armor)
  if (player.hp < player.maxHp * 0.3) return Math.floor(dmgIn * 1.25);
  return dmgIn;
}
window.getMageVulnerability = getMageVulnerability;

// â”€â”€â”€ CLERIC PRAYER CHARGE EMPOWER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getClericHealBonus(baseHeal) {
  if (gameState.character?.class !== 'cleric') return baseHeal;
  const cr = window.classResource;
  const wisMod = Math.floor(((gameState.character?.stats?.wis || 10) - 10) / 2);
  const bonus = wisMod * 3;
  if (cr.current > 0) {
    return Math.floor(baseHeal * 1.5) + bonus; // 50% bonus when charges available
  }
  return baseHeal + bonus;
}
window.getClericHealBonus = getClericHealBonus;

// â”€â”€â”€ RANGER FOCUS POWERED SPELL BONUS â”€â”€â”€â”€â”€â”€â”€
function getRangerFocusBonus(baseDmg) {
  if (gameState.character?.class !== 'ranger') return { dmg: baseDmg, spent: false };
  const cr = window.classResource;
  if (cr.current >= 2) {
    spendResource(2);
    addLog('ğŸ¯ 2 Focus spent â€” Powered Shot!', 'holy');
    return { dmg: Math.floor(baseDmg * 1.6), spent: true };
  }
  if (cr.current >= 1) {
    spendResource(1);
    return { dmg: Math.floor(baseDmg * 1.25), spent: true };
  }
  return { dmg: baseDmg, spent: false };
}
window.getRangerFocusBonus = getRangerFocusBonus;

// â”€â”€â”€ CSS FOR RESOURCE BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const resourceBarCSS = `
#class-resource-bar {
  padding: 6px 10px;
  background: rgba(0,0,0,0.4);
  border-radius: 4px;
  border: 1px solid rgba(201,168,76,0.15);
  margin-bottom: 4px;
}
.crb-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:3px; }
.crb-label { font-family:'Cinzel',serif; font-size:0.62rem; color:var(--text-dim); letter-spacing:0.08em; }
.crb-val   { font-family:'Cinzel',serif; font-size:0.62rem; color:var(--gold); }
.crb-track {
  height:6px; background:rgba(255,255,255,0.06); border-radius:3px;
  overflow:hidden; transition:box-shadow 0.3s;
}
.crb-fill { height:100%; border-radius:3px; transition:width 0.4s ease, background 0.3s; }
#class-resource-bar.berserker .crb-track { box-shadow: 0 0 12px rgba(192,57,43,0.8); }
#class-resource-bar.overloaded .crb-track { box-shadow: 0 0 12px rgba(176,96,255,0.8); }
`;
const crStyle = document.createElement('style');
crStyle.textContent = resourceBarCSS;
document.head.appendChild(crStyle);

// â”€â”€â”€ INJECT RESOURCE BAR INTO COMBAT UI â”€â”€â”€â”€â”€â”€
// Called by combat.js updateCombatUI after it renders
function injectClassResourceBar() {
  const cr = window.classResource;
  if (!cr.type) return;
  // Find or create the bar
  let bar = document.getElementById('class-resource-bar');
  if (!bar) {
    bar = document.createElement('div');
    bar.id = 'class-resource-bar';
    // Insert after cp-ap-row
    const apRow = document.querySelector('.cp-ap-row');
    if (apRow) apRow.parentNode.insertBefore(bar, apRow.nextSibling);
    else {
      const actions = document.querySelector('.cp-player-actions');
      if (actions) actions.prepend(bar);
    }
  }
  const pct = (cr.current / cr.max) * 100;
  bar.innerHTML = `
    <div class="crb-row">
      <span class="crb-label">${cr.icon} ${cr.label.toUpperCase()}</span>
      <span class="crb-val">${cr.current}/${cr.max}</span>
    </div>
    <div class="crb-track"><div class="crb-fill" style="width:${pct}%;background:${cr.color}"></div></div>
  `;
}
window.injectClassResourceBar = injectClassResourceBar;

